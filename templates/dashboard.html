<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Customer Visualization Dashboards - å¾®ä¿¡èŠå¤©è®°å½•åˆ†æ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            padding: 20px;
        }
        
        /* å®¢æˆ·é€‰æ‹©å™¨æ ·å¼ */
        .customer-selector-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .selector-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .customer-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .customer-selector label {
            font-weight: 500;
            color: #495057;
            margin-right: 10px;
        }
        
        .customer-selector select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .customer-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .customer-selector select option {
            padding: 8px;
        }
        
        .view-all-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        
        .view-all-btn:hover {
            transform: translateY(-2px);
        }
        
        .view-all-btn.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .selected-customer-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .selected-customer-info.show {
            display: block;
        }
        
        .selected-customer-name {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .selected-customer-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .selected-stat {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .selected-stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .selected-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .overview-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .overview-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .customer-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .customer-overview-title {
            grid-column: 1 / -1;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .customer-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .customer-card:hover {
            transform: translateY(-5px);
        }
        
        .customer-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .customer-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .heatmap-container {
            overflow-x: auto;
            padding: 20px 0;
        }
        
        .calendar-heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 15px;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 5px;
        }
        
        .calendar-header-cell {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            padding: 5px;
        }
        
        .calendar-week {
            display: contents;
        }
        
        .calendar-day {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease;
            min-width: 20px;
            min-height: 20px;
        }
        
        .calendar-day:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }
        
        .calendar-day.empty:hover {
            transform: none;
            box-shadow: none;
        }
        
        .wordcloud-container {
            text-align: center;
        }
        
        .wordcloud-image {
            max-width: 100%;
            height: 300px;
            object-fit: contain;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        .month-label {
            font-size: 12px;
            color: #666;
            margin: 10px 0 5px 0;
        }
        
        .labels-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .labels-container {
            display: grid;
            gap: 20px;
        }
        
        .customer-labels {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .customer-labels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .customer-name-label {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .label-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .label-category {
            background: white;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }
        
        .label-category-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .label-group {
            margin-bottom: 12px;
        }
        
        .label-item {
            display: inline-block;
            padding: 4px 10px;
            margin: 3px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ä¸åŒç±»å‹æ ‡ç­¾çš„é¢œè‰² */
        .label-date {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .label-time {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .label-behaviour {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .label-analysis {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .label-custom {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .no-labels {
            color: #6c757d;
            font-style: italic;
            padding: 10px;
            text-align: center;
            background: white;
            border-radius: 6px;
        }
        
        .custom-labels-input {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #ced4da;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .custom-labels-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .add-custom-label-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-custom-label-btn:hover {
            background: #218838;
        }
        
        @media (max-width: 768px) {
            .customer-cards {
                grid-template-columns: 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .label-categories {
                grid-template-columns: 1fr;
            }
            
            .customer-labels-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <nav class="sidebar">
            <h2>åŠŸèƒ½å¯¼èˆª</h2>
            <div class="nav-buttons">
                <a href="/data_import" class="nav-btn">Data Import</a>
                <a href="/dashboard" class="nav-btn active">Individual Customer Visualization Dashboards</a>
                <a href="/table" class="nav-btn">Sortable and Filterable Table</a>
            </div>
        </nav>
        
        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
        <main class="content">
            <div class="dashboard-container">
                <!-- Customer Selector -->
                <div class="customer-selector-section">
                    <div class="selector-header">
                        <h2 class="selector-title">å®¢æˆ·é€‰æ‹©å™¨</h2>
                    </div>
                    <div class="customer-selector">
                        <label for="customerSelect">é€‰æ‹©å®¢æˆ·ï¼š</label>
                        <select id="customerSelect">
                            <option value="all">æ‰€æœ‰å®¢æˆ·</option>
                        </select>
                        <button class="view-all-btn active" id="viewAllBtn" onclick="showAllCustomers()">æŸ¥çœ‹æ‰€æœ‰å®¢æˆ·</button>
                    </div>
                    <div class="selected-customer-info" id="selectedCustomerInfo">
                        <div class="selected-customer-name" id="selectedCustomerName">-</div>
                        <div class="selected-customer-stats" id="selectedCustomerStats">
                            <div class="selected-stat">
                                <div class="selected-stat-label">èŠå¤©å¤©æ•°</div>
                                <div class="selected-stat-value" id="selectedChatDays">-</div>
                            </div>
                            <div class="selected-stat">
                                <div class="selected-stat-label">æ€»æ¶ˆæ¯æ•°</div>
                                <div class="selected-stat-value" id="selectedMessages">-</div>
                            </div>
                            <div class="selected-stat">
                                <div class="selected-stat-label">è½¬è´¦é‡‘é¢</div>
                                <div class="selected-stat-value" id="selectedAmount">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Interaction Overview -->
                <div class="overview-section">
                    <h2 class="overview-title">Customer Interaction Overview</h2>
                    <div id="customerOverview" class="customer-cards">
                        <div class="loading">æ­£åœ¨åŠ è½½å®¢æˆ·æ•°æ®...</div>
                    </div>
                </div>
                
                <!-- Customer Labels Section -->
                <div class="labels-section">
                    <h2 class="overview-title">å®¢æˆ·æ ‡ç­¾ç³»ç»Ÿ</h2>
                    <div id="customerLabels" class="labels-container">
                        <div class="loading">æ­£åœ¨åŠ è½½å®¢æˆ·æ ‡ç­¾...</div>
                    </div>
                </div>
                
                <!-- å¯è§†åŒ–å›¾è¡¨ -->
                <div class="charts-section">
                    <!-- Chat Heatmap -->
                    <div class="chart-card">
                        <h3 class="chart-title">Chat Heatmap</h3>
                        <div class="heatmap-container">
                            <div id="heatmapChart" class="loading">æ­£åœ¨åŠ è½½èŠå¤©çƒ­åŠ›å›¾...</div>
                        </div>
                    </div>
                    
                    <!-- Chat Time Distribution -->
                    <div class="chart-card">
                        <h3 class="chart-title">Chat Time Distribution Line Chart</h3>
                        <div class="chart-container">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Purchase Ratio -->
                    <div class="chart-card">
                        <h3 class="chart-title">Purchase vs. Non-Purchase Chat Ratio</h3>
                        <div class="chart-container">
                            <canvas id="purchaseChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Word Cloud -->
                    <div class="chart-card">
                        <h3 class="chart-title">èŠå¤©å…³é”®è¯äº‘å›¾</h3>
                        <div class="wordcloud-container">
                            <div id="wordcloudChart" class="loading">æ­£åœ¨ç”Ÿæˆå…³é”®è¯äº‘å›¾...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let timeChart = null;
        let purchaseChart = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeCustomerSelector();
            loadAllData();
        });

        // åŠ è½½æ‰€æœ‰æ•°æ®çš„ç»Ÿä¸€å‡½æ•°
        async function loadAllData(selectedCustomer = 'all') {
            await Promise.all([
                loadCustomerOverview(selectedCustomer),
                loadAllCustomerLabels(),
                loadHeatmap(),
                loadTimeDistribution(),
                loadPurchaseRatio(),
                loadWordcloud()
            ]);
        }

        // åˆå§‹åŒ–å®¢æˆ·é€‰æ‹©å™¨
        async function initializeCustomerSelector() {
            try {
                const response = await fetch('/api/customer_overview');
                const customers = await response.json();
                
                const selectElement = document.getElementById('customerSelect');
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™"æ‰€æœ‰å®¢æˆ·"é€‰é¡¹
                selectElement.innerHTML = '<option value="all">æ‰€æœ‰å®¢æˆ·</option>';
                
                // æ·»åŠ å®¢æˆ·é€‰é¡¹
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_name;
                    option.textContent = customer.customer_name;
                    selectElement.appendChild(option);
                });
                
                // æ·»åŠ é€‰æ‹©å˜åŒ–äº‹ä»¶ç›‘å¬å™¨
                selectElement.addEventListener('change', function() {
                    handleCustomerChange(this.value);
                });
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å®¢æˆ·é€‰æ‹©å™¨å¤±è´¥:', error);
            }
        }
        
        // å¤„ç†å®¢æˆ·é€‰æ‹©å˜åŒ–
        async function handleCustomerChange(customerName) {
            const selectedInfo = document.getElementById('selectedCustomerInfo');
            const viewAllBtn = document.getElementById('viewAllBtn');
            
            if (customerName === 'all') {
                // æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·
                selectedInfo.classList.remove('show');
                viewAllBtn.classList.add('active');
                loadAllCustomersData();
            } else {
                // æ˜¾ç¤ºé€‰å®šå®¢æˆ·
                selectedInfo.classList.add('show');
                viewAllBtn.classList.remove('active');
                await loadSelectedCustomerData(customerName);
            }
        }
        
        // åŠ è½½é€‰å®šå®¢æˆ·çš„æ•°æ®
        async function loadSelectedCustomerData(customerName) {
            try {
                const response = await fetch('/api/customer_overview');
                const customers = await response.json();
                
                const selectedCustomer = customers.find(c => c.customer_name === customerName);
                
                if (selectedCustomer) {
                    // æ›´æ–°é€‰ä¸­å®¢æˆ·ä¿¡æ¯
                    document.getElementById('selectedCustomerName').textContent = selectedCustomer.customer_name;
                    document.getElementById('selectedChatDays').textContent = selectedCustomer.chat_days + ' å¤©';
                    document.getElementById('selectedMessages').textContent = selectedCustomer.total_messages + ' æ¡';
                    const transferAmount = selectedCustomer.transfer_amount > 0 ? `ï¿¥${selectedCustomer.transfer_amount.toFixed(2)}` : 'ï¿¥0.00';
                    document.getElementById('selectedAmount').textContent = transferAmount;
                    
                    // æ›´æ–°Customer Interaction OverviewåŒºåŸŸ
                    await loadCustomerOverview(customerName);
                    
                    // åŠ è½½è¯¥å®¢æˆ·çš„æ‰€æœ‰æ•°æ®
                    await loadCustomerCharts(customerName);
                    await loadCustomerLabelsForCustomer(customerName);
                }
                
            } catch (error) {
                console.error('åŠ è½½é€‰å®šå®¢æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ‰€æœ‰å®¢æˆ·æ•°æ®
        function loadAllCustomersData() {
            // æ¢å¤åˆ°æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·çš„çŠ¶æ€
            loadCustomerOverview();
            loadCustomerLabels();
            loadHeatmap();
            loadTimeDistribution();
            loadPurchaseRatio();
            loadWordcloud();
        }
        
        // æŸ¥çœ‹æ‰€æœ‰å®¢æˆ·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function showAllCustomers() {
            const selectElement = document.getElementById('customerSelect');
            selectElement.value = 'all';
            handleCustomerChange('all');
        }
        
        // åŠ è½½ç‰¹å®šå®¢æˆ·çš„å›¾è¡¨æ•°æ®
        async function loadCustomerCharts(customerName) {
            try {
                // åŠ è½½çƒ­åŠ›å›¾
                const heatmapResponse = await fetch(`/api/chat_heatmap?customer=${encodeURIComponent(customerName)}`);
                const heatmapData = await heatmapResponse.json();
                renderHeatmap(heatmapData);
                
                // åŠ è½½æ—¶é—´åˆ†å¸ƒ
                const timeResponse = await fetch(`/api/time_distribution?customer=${encodeURIComponent(customerName)}`);
                const timeData = await timeResponse.json();
                renderTimeDistribution(timeData);
                
                // åŠ è½½è´­ä¹°æ¯”ä¾‹
                const purchaseResponse = await fetch(`/api/purchase_ratio?customer=${encodeURIComponent(customerName)}`);
                const purchaseData = await purchaseResponse.json();
                renderPurchaseRatio(purchaseData);
                
                // åŠ è½½è¯äº‘
                const wordcloudResponse = await fetch(`/api/wordcloud?customer=${encodeURIComponent(customerName)}`);
                const wordcloudData = await wordcloudResponse.json();
                renderWordcloud(wordcloudData);
                
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç‰¹å®šå®¢æˆ·çš„æ ‡ç­¾
        async function loadCustomerLabelsForCustomer(customerName) {
            try {
                const response = await fetch('/api/customer_labels');
                const labelsData = await response.json();
                
                const container = document.getElementById('customerLabels');
                const customerLabels = labelsData.filter(l => l.customer_name === customerName);
                
                if (customerLabels.length === 0) {
                    container.innerHTML = '<div class="no-data">è¯¥å®¢æˆ·æš‚æ— æ ‡ç­¾æ•°æ®</div>';
                    return;
                }
                
                let html = '';
                customerLabels.forEach(customer => {
                    html += renderCustomerLabels(customer);
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½å®¢æˆ·æ ‡ç­¾å¤±è´¥:', error);
                document.getElementById('customerLabels').innerHTML = 
                    '<div class="no-data">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // æ¸²æŸ“çƒ­åŠ›å›¾
        function renderHeatmap(heatmapData) {
            const container = document.getElementById('heatmapChart');
            
            if (!heatmapData || Object.keys(heatmapData).length === 0) {
                container.innerHTML = '<div class="no-data">è¯¥å®¢æˆ·æš‚æ— èŠå¤©æ•°æ®</div>';
                return;
            }
            
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            
            let html = `
                <div class="month-label">${heatmapData.year}å¹´ ${heatmapData.month}æœˆ</div>
                <div class="calendar-header">
                    ${weekDays.map(day => `<div class="calendar-header-cell">${day}</div>`).join('')}
                </div>
                <div class="calendar-heatmap">
            `;
            
            heatmapData.weeks.forEach(week => {
                week.forEach(dayData => {
                    if (dayData.day === null) {
                        html += `<div class="calendar-day empty"></div>`;
                    } else {
                        const count = dayData.count;
                        const intensity = Math.min(count / 10, 1);
                        const color = getColorByIntensity(intensity);
                        const textColor = intensity > 0.5 ? 'white' : '#333';
                        
                        html += `
                            <div class="calendar-day" 
                                 style="background-color: ${color}; color: ${textColor};"
                                 title="${dayData.date}: ${count}æ¡æ¶ˆæ¯">
                                ${dayData.day}
                            </div>
                        `;
                    }
                });
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // æ¸²æŸ“æ—¶é—´åˆ†å¸ƒå›¾
        function renderTimeDistribution(data) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            
            if (timeChart) {
                timeChart.destroy();
            }
            
            timeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'èŠå¤©æ•°é‡',
                        data: data.message_counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æ¶ˆæ¯æ•°é‡'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“è´­ä¹°æ¯”ä¾‹å›¾
        function renderPurchaseRatio(data) {
            const ctx = document.getElementById('purchaseChart').getContext('2d');
            
            if (purchaseChart) {
                purchaseChart.destroy();
            }
            
            if (!data || !data.labels || !data.values || data.labels.length === 0) {
                ctx.font = '14px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('è¯¥å®¢æˆ·æš‚æ— è´­ä¹°æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            purchaseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: ['#667eea', '#764ba2', '#f59e0b', '#10b981'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} æ¡æ¶ˆæ¯ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“è¯äº‘å›¾
        function renderWordcloud(data) {
            const container = document.getElementById('wordcloudChart');
            
            if (!data.wordcloud || data.wordcloud === '') {
                container.innerHTML = '<div class="no-data">è¯¥å®¢æˆ·æš‚æ— å…³é”®è¯æ•°æ®</div>';
                return;
            }
            
            if (data.wordcloud.includes('data:image')) {
                container.innerHTML = `
                    <img src="${data.wordcloud}" alt="å…³é”®è¯äº‘å›¾" class="wordcloud-image">
                `;
            } else if (data.words && data.words.length > 0) {
                let html = '<div style="text-align: left; padding: 20px;"><h4 style="margin-bottom: 15px; color: #2c3e50;">é«˜é¢‘å…³é”®è¯ï¼š</h4><ul style="list-style: none; padding: 0;">';
                data.words.slice(0, 10).forEach(item => {
                    const fontSize = Math.max(12, Math.min(24, 12 + item.count));
                    html += `<li style="margin: 5px 0; display: inline-block; margin-right: 15px;"><span style="font-size: ${fontSize}px; color: #667eea; font-weight: bold;">${item.word}</span> (${item.count}æ¬¡)</li>`;
                });
                html += '</ul></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="no-data">è¯¥å®¢æˆ·æš‚æ— å…³é”®è¯æ•°æ®</div>';
            }
        }

        // åŠ è½½å®¢æˆ·æ¦‚è§ˆæ•°æ®
        async function loadCustomerOverview(selectedCustomer = 'all') {
            try {
                const response = await fetch('/api/customer_overview');
                const customers = await response.json();
                
                const container = document.getElementById('customerOverview');
                
                if (customers.length === 0) {
                    container.innerHTML = '<div class="no-data">æš‚æ— å®¢æˆ·æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ èŠå¤©è®°å½•</div>';
                    return;
                }
                
                // æ ¹æ®é€‰æ‹©çš„å®¢æˆ·è¿›è¡Œç­›é€‰
                let displayCustomers = customers;
                if (selectedCustomer !== 'all') {
                    displayCustomers = customers.filter(customer => customer.customer_name === selectedCustomer);
                }
                
                if (displayCustomers.length === 0 && selectedCustomer !== 'all') {
                    container.innerHTML = `<div class="no-data">æœªæ‰¾åˆ°å®¢æˆ· "${selectedCustomer}" çš„æ•°æ®</div>`;
                    return;
                }
                
                let html = '';
                displayCustomers.forEach(customer => {
                    const transferAmount = customer.transfer_amount > 0 ? `ï¿¥${customer.transfer_amount.toFixed(2)}` : 'ï¿¥0.00';
                    html += `
                        <div class="customer-card">
                            <div class="customer-name">${customer.customer_name}</div>
                            <div class="customer-stats">
                                <div class="stat-item">
                                    <span class="stat-label">èŠå¤©å¤©æ•°</span>
                                    <span class="stat-value">${customer.chat_days} å¤©</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">æ€»æ¶ˆæ¯æ•°</span>
                                    <span class="stat-value">${customer.total_messages} æ¡</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">è½¬è´¦æ€»é¢</span>
                                    <span class="stat-value">${transferAmount}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // å¦‚æœé€‰æ‹©äº†ç‰¹å®šå®¢æˆ·ï¼Œæ·»åŠ æ ‡é¢˜
                if (selectedCustomer !== 'all') {
                    html = `<div class="customer-overview-title">å®¢æˆ·ï¼š${selectedCustomer}</div>` + html;
                    console.log(`æ˜¾ç¤ºå®¢æˆ· "${selectedCustomer}" çš„æ¦‚è§ˆæ•°æ®`);
                } else {
                    console.log('æ˜¾ç¤ºæ‰€æœ‰å®¢æˆ·çš„æ¦‚è§ˆæ•°æ®');
                }
                
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('customerOverview').innerHTML = 
                    '<div class="no-data">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
            }
        }

        // åŠ è½½èŠå¤©çƒ­åŠ›å›¾
        async function loadHeatmap() {
            try {
                const response = await fetch('/api/chat_heatmap');
                const heatmapData = await response.json();
                
                const container = document.getElementById('heatmapChart');
                
                if (!heatmapData || Object.keys(heatmapData).length === 0) {
                    container.innerHTML = '<div class="no-data">æš‚æ— èŠå¤©æ•°æ®</div>';
                    return;
                }
                
                const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                
                let html = `
                    <div class="month-label">${heatmapData.year}å¹´ ${heatmapData.month}æœˆ</div>
                    <div class="calendar-header">
                        ${weekDays.map(day => `<div class="calendar-header-cell">${day}</div>`).join('')}
                    </div>
                    <div class="calendar-heatmap">
                `;
                
                heatmapData.weeks.forEach(week => {
                    week.forEach(dayData => {
                        if (dayData.day === null) {
                            html += `<div class="calendar-day empty"></div>`;
                        } else {
                            const count = dayData.count;
                            const intensity = Math.min(count / 10, 1); // æœ€å¤š10æ¡æ¶ˆæ¯ä¸ºæœ€å¤§å¼ºåº¦
                            const color = getColorByIntensity(intensity);
                            const textColor = intensity > 0.5 ? 'white' : '#333';
                            
                            html += `
                                <div class="calendar-day" 
                                     style="background-color: ${color}; color: ${textColor};"
                                     title="${dayData.date}: ${count}æ¡æ¶ˆæ¯">
                                    ${dayData.day}
                                </div>
                            `;
                        }
                    });
                });
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('heatmapChart').innerHTML = 
                    '<div class="no-data">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ ¹æ®å¼ºåº¦è·å–é¢œè‰²
        function getColorByIntensity(intensity) {
            if (intensity === 0) return '#f0f0f0';
            const colors = ['#e8f5e8', '#c8e6c9', '#a5d6a7', '#81c784', '#66bb6a', '#4caf50', '#43a047', '#388e3c'];
            const index = Math.floor(intensity * (colors.length - 1));
            return colors[index];
        }

        // åŠ è½½æ—¶é—´åˆ†å¸ƒå›¾
        async function loadTimeDistribution() {
            try {
                const response = await fetch('/api/time_distribution');
                const data = await response.json();
                
                const ctx = document.getElementById('timeChart').getContext('2d');
                
                if (timeChart) {
                    timeChart.destroy();
                }
                
                timeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.hours.map(h => `${h}:00`),
                        datasets: [{
                            label: 'èŠå¤©æ•°é‡',
                            data: data.message_counts,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'æ¶ˆæ¯æ•°é‡'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('æ—¶é—´åˆ†å¸ƒå›¾åŠ è½½å¤±è´¥:', error);
            }
        }

        // åŠ è½½è´­ä¹°æ¯”ä¾‹å›¾
        async function loadPurchaseRatio() {
            try {
                const response = await fetch('/api/purchase_ratio');
                const data = await response.json();
                
                console.log('è´­ä¹°æ¯”ä¾‹æ•°æ®:', data); // è°ƒè¯•æ—¥å¿—
                
                const ctx = document.getElementById('purchaseChart').getContext('2d');
                
                if (purchaseChart) {
                    purchaseChart.destroy();
                }
                
                // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
                if (!data || !data.labels || !data.values || data.labels.length === 0) {
                    console.error('è´­ä¹°æ¯”ä¾‹æ•°æ®æ— æ•ˆ:', data);
                    // æ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#999';
                    ctx.textAlign = 'center';
                    ctx.fillText('æš‚æ— è´­ä¹°æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                // ç¡®ä¿æ•°å€¼éƒ½æ˜¯æ­£æ•°
                const validValues = data.values.map(v => Math.max(0, v));
                const hasValidData = validValues.some(v => v > 0);
                
                if (!hasValidData) {
                    console.error('è´­ä¹°æ¯”ä¾‹æ•°å€¼éƒ½ä¸º0');
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#999';
                    ctx.textAlign = 'center';
                    ctx.fillText('æš‚æ— æœ‰æ•ˆæ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                purchaseChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: validValues,
                            backgroundColor: ['#667eea', '#764ba2', '#f59e0b', '#10b981'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} æ¡æ¶ˆæ¯ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('è´­ä¹°æ¯”ä¾‹å›¾åŠ è½½å¤±è´¥:', error);
                // åœ¨canvasä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const ctx = document.getElementById('purchaseChart').getContext('2d');
                ctx.font = '14px Arial';
                ctx.fillStyle = '#ff4444';
                ctx.textAlign = 'center';
                ctx.fillText('åŠ è½½å¤±è´¥', ctx.canvas.width / 2, ctx.canvas.height / 2);
            }
        }

        // åŠ è½½è¯äº‘å›¾
        async function loadWordcloud() {
            try {
                const response = await fetch('/api/wordcloud');
                const data = await response.json();
                
                const container = document.getElementById('wordcloudChart');
                
                if (!data.wordcloud || data.wordcloud === '') {
                    container.innerHTML = '<div class="no-data">æš‚æ— å…³é”®è¯æ•°æ®</div>';
                    return;
                }
                
                // å¦‚æœæœ‰è¯äº‘å›¾ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼›å¦‚æœæ²¡æœ‰ï¼Œæ˜¾ç¤ºè¯é¢‘åˆ—è¡¨
                if (data.wordcloud.includes('data:image')) {
                    container.innerHTML = `
                        <img src="${data.wordcloud}" alt="å…³é”®è¯äº‘å›¾" class="wordcloud-image">
                    `;
                } else if (data.words && data.words.length > 0) {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ˜¾ç¤ºé«˜é¢‘è¯åˆ—è¡¨
                    let html = '<div style="text-align: left; padding: 20px;"><h4 style="margin-bottom: 15px; color: #2c3e50;">é«˜é¢‘å…³é”®è¯ï¼š</h4><ul style="list-style: none; padding: 0;">';
                    data.words.slice(0, 10).forEach(item => {
                        const fontSize = Math.max(12, Math.min(24, 12 + item.count));
                        html += `<li style="margin: 5px 0; display: inline-block; margin-right: 15px;"><span style="font-size: ${fontSize}px; color: #667eea; font-weight: bold;">${item.word}</span> (${item.count}æ¬¡)</li>`;
                    });
                    html += '</ul></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-data">æš‚æ— å…³é”®è¯æ•°æ®</div>';
                }
            } catch (error) {
                console.error('è¯äº‘å›¾åŠ è½½å¤±è´¥:', error);
                document.getElementById('wordcloudChart').innerHTML = 
                    '<div class="no-data">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½å®¢æˆ·æ ‡ç­¾
        async function loadCustomerLabels() {
            try {
                const response = await fetch('/api/customer_labels');
                const labelsData = await response.json();
                
                const container = document.getElementById('customerLabels');
                
                if (labelsData.error) {
                    container.innerHTML = `<div class="no-data">åŠ è½½å¤±è´¥: ${labelsData.error}</div>`;
                    return;
                }
                
                if (!labelsData || labelsData.length === 0) {
                    container.innerHTML = '<div class="no-data">æš‚æ— å®¢æˆ·æ ‡ç­¾æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ èŠå¤©è®°å½•</div>';
                    return;
                }
                
                let html = '';
                labelsData.forEach(customer => {
                    html += renderCustomerLabels(customer);
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('å®¢æˆ·æ ‡ç­¾åŠ è½½å¤±è´¥:', error);
                document.getElementById('customerLabels').innerHTML = 
                    '<div class="no-data">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“å•ä¸ªå®¢æˆ·çš„æ ‡ç­¾
        function renderCustomerLabels(customer) {
            const { customer_name, basic_labels, analysis_labels, custom_labels } = customer;
            
            let html = `
                <div class="customer-labels">
                    <div class="customer-labels-header">
                        <div class="customer-name-label">${customer_name}</div>
                    </div>
                    <div class="label-categories">
            `;
            
            // åŸºç¡€æ ‡ç­¾
            html += `
                <div class="label-category">
                    <div class="label-category-title">ğŸ“Š åŸºç¡€æ ‡ç­¾</div>
                    
                    <div class="label-group">
                        <div style="font-weight: 500; margin-bottom: 5px; color: #495057;">æ—¥æœŸæ ‡ç­¾</div>
                        ${renderLabelItems(basic_labels.date_labels || [], 'date')}
                    </div>
                    
                    <div class="label-group">
                        <div style="font-weight: 500; margin-bottom: 5px; color: #495057;">æ—¶é—´æ ‡ç­¾</div>
                        ${renderLabelItems(basic_labels.time_labels || [], 'time')}
                    </div>
                    
                    <div class="label-group">
                        <div style="font-weight: 500; margin-bottom: 5px; color: #495057;">è¡Œä¸ºæ ‡ç­¾</div>
                        ${renderLabelItems(basic_labels.behaviour_labels || [], 'behaviour')}
                    </div>
                </div>
            `;
            
            // RFM åˆ†ææ ‡ç­¾
            html += `
                <div class="label-category">
                    <div class="label-category-title">ğŸ“ˆ RFM åˆ†ææ ‡ç­¾</div>
                    <div class="label-group">
                        <div style="font-weight: 500; margin-bottom: 5px; color: #495057;">
                            RFM æ¨¡å‹åŸºäºå®¢æˆ·æœ€è¿‘è´­ä¹°æ—¶é—´(R)ã€è´­ä¹°é¢‘ç‡(F)ã€æ¶ˆè´¹é‡‘é¢(M)åˆ†æå®¢æˆ·ä»·å€¼
                        </div>
                        ${renderLabelItems(analysis_labels?.rfm_labels || [], 'analysis')}
                    </div>
                </div>
            `;
            
            // Lifecycle åˆ†ææ ‡ç­¾
            html += `
                <div class="label-category">
                    <div class="label-category-title">ğŸ”„ å®¢æˆ·ç”Ÿå‘½å‘¨æœŸæ ‡ç­¾</div>
                    <div class="label-group">
                        <div style="font-weight: 500; margin-bottom: 5px; color: #495057;">
                            åŸºäºå®¢æˆ·äº’åŠ¨å’Œè´­ä¹°è¡Œä¸ºçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µåˆ†æ
                        </div>
                        ${renderLabelItems(analysis_labels?.lifecycle_labels || [], 'analysis')}
                    </div>
                </div>
            `;
            
            // è‡ªå®šä¹‰æ ‡ç­¾
            html += `
                <div class="label-category">
                    <div class="label-category-title">ğŸ·ï¸ è‡ªå®šä¹‰æ ‡ç­¾</div>
                    <div class="custom-labels-input">
                        <div style="font-weight: 500; margin-bottom: 8px; color: #495057;">æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ï¼š</div>
                        <input type="text" id="custom-label-${customer_name.replace(/\s/g, '-')}" 
                               placeholder="è¾“å…¥æ ‡ç­¾åç§°..." maxlength="20">
                        <button class="add-custom-label-btn" 
                                onclick="addCustomLabel('${customer_name}')">
                            æ·»åŠ æ ‡ç­¾
                        </button>
                        <div id="custom-tags-${customer_name.replace(/\s/g, '-')}">
                            ${renderLabelItems(custom_labels || [], 'custom')}
                        </div>
                    </div>
                </div>
            `;
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        // æ¸²æŸ“æ ‡ç­¾é¡¹
        function renderLabelItems(labels, type) {
            if (!labels || labels.length === 0) {
                return '<div class="no-labels">æš‚æ— æ ‡ç­¾</div>';
            }
            
            return labels.map(label => 
                `<span class="label-item label-${type}">${label}</span>`
            ).join('');
        }

        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
        async function addCustomLabel(customerName) {
            const inputId = `custom-label-${customerName.replace(/\s/g, '-')}`;
            const input = document.getElementById(inputId);
            
            if (!input.value.trim()) {
                alert('è¯·è¾“å…¥æ ‡ç­¾åç§°');
                return;
            }
            
            const labelName = input.value.trim();
            
            try {
                // è¿™é‡Œå¯ä»¥æ·»åŠ APIè°ƒç”¨æ¥ä¿å­˜è‡ªå®šä¹‰æ ‡ç­¾
                // æš‚æ—¶åªåœ¨å‰ç«¯æ˜¾ç¤º
                const tagsContainer = document.getElementById(`custom-tags-${customerName.replace(/\s/g, '-')}`);
                const newTag = document.createElement('span');
                newTag.className = 'label-item label-custom';
                newTag.textContent = labelName;
                
                const noLabels = tagsContainer.querySelector('.no-labels');
                if (noLabels) {
                    noLabels.remove();
                }
                
                tagsContainer.appendChild(newTag);
                input.value = '';
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                newTag.style.animation = 'pulse 0.5s';
                
            } catch (error) {
                console.error('æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾å¤±è´¥:', error);
                alert('æ·»åŠ æ ‡ç­¾å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
    </script>
</body>
</html>